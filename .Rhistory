units = "in", limitsize = FALSE)
# plot
set.seed(20230901)
df.target = readRDS("./data/df.target_germany.Rds")
df.gap = readRDS("./data/df.gap_germany.Rds")
df.quantile = df.gap %>%
group_by(time) %>%
summarise(quantile.sc.975 = quantile(gap.sc, 0.975, na.rm = T),
quantile.sc.025 = quantile(gap.sc, 0.025, na.rm = T),
quantile.dsc.975 = quantile(gap.dsc, 0.975, na.rm = T),
quantile.dsc.025 = quantile(gap.dsc, 0.025, na.rm = T)) %>%
mutate(group = "quantile")
color.sc = "#2ab7ca"
color.dsc = "#fe4a49"
# color.sc = "grey70"
# color.dsc = "grey30"
colors = c("Target TE (SC)" = color.sc,
"Target TE (DSC)" = color.dsc)
fills = c("95% Quantile (SC)" = color.sc,
"95% Quantile (DSC)" = color.dsc)
set.seed(20230812)
group.sample = sample(unique(df.gap$group), 100)
fig_germany = df.gap %>%
filter(group %in% group.sample) %>%
ggplot(aes(x = time, group = group)) +
annotate("rect", xmin = 1990, xmax = 2000,
ymin = -9000, ymax = 9000, alpha = .3) +
geom_line(aes(y = gap.sc), col = color.sc, alpha = 0.4) +
geom_line(aes(y = gap.dsc), col = color.dsc, alpha = 0.4) +
geom_ribbon(aes(ymin = quantile.sc.025,
ymax = quantile.sc.975,
fill="95% Quantile (SC)"),
data = df.quantile, alpha=0.5) +
geom_ribbon(aes(ymin = quantile.dsc.025,
ymax = quantile.dsc.975,
fill="95% Quantile (DSC)"),
data = df.quantile, alpha=0.5) +
geom_line(aes(y = gap.sc, color = "Target TE (SC)"),
data = df.target, size = 1) +
geom_line(aes(y = gap.dsc, color = "Target TE (DSC)"),
data = df.target, size = 1) +
scale_color_manual(name = NULL, values = colors) +
scale_fill_manual(name = NULL, values = fills) +
geom_vline(xintercept = 1990, linetype="dashed", col = "grey20") +
geom_hline(yintercept = 0, linetype="dashed", col = "grey20") +
annotate("text", x = 1995, y = 6800,
label = "t = -4.0951\nP < 0.0001", col = "grey20") +
annotate("text", x = 1989, y = 4800, angle = 90,
label = "Treatment", col = "grey20") +
annotate("text", x = 2007, y = -3000, label = "bar(MSE)[SC]==2.47(M)", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
annotate("text", x = 2007, y = -5000, label = "bar(MSE)[DSC]==2.75(M)", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
coord_cartesian(xlim=c(1970, 2010),ylim=c(-8000,8000)) +
xlab("Year") +
ylab("Treatment Effect") +
theme_bw() +
theme(legend.position = c(0.25, 0.2),
legend.box = "horizontal",
legend.background = element_rect(fill=NA))
fig_all = ggpubr::ggarrange(fig_basque + ggpubr::rremove("ylab") +
ggpubr::rremove("xlab"),
fig_tobacco + ggpubr::rremove("ylab") +
ggpubr::rremove("xlab"),
fig_germany + ggpubr::rremove("ylab") +
ggpubr::rremove("xlab"),
labels = c("Basque Terrorism",
"California Tobacco",
"German Reunification"),
label.x = 0.1,
label.y = 0.9,
hjust = c(0, 0, 0),
font.label = list(size = 16, color = "grey20",
face = "bold"),
ncol = 1, nrow = 3,
# common.legend = TRUE, legend = "bottom",
align = "hv")
fig_all = ggpubr::annotate_figure(fig_all,
left = grid::textGrob("Treatment Effect (TE)",
rot = 90, vjust = 1,
gp = grid::gpar(cex = 1.3)),
bottom = grid::textGrob("Time",
gp = grid::gpar(cex = 1.3)))
ggsave("./figures/placebo_all.pdf",
fig_all,  width = 7, height = 7,
units = "in", limitsize = FALSE)
# df.gap
df.mse = readRDS("./data/df.mse_basque_pred.Rds")
avg.mse.sc = mean(df.mse$mse.postT.raw, na.rm = TRUE)
avg.mse.dsc = mean(df.mse$mse.postT.TFDTW, na.rm = TRUE)
avg.mse.sc
avg.mse.dsc
avg.mse.sc = mean(df.mse$mse.postT.raw, na.rm = TRUE)
avg.mse.dsc = mean(df.mse$mse.postT.TFDTW, na.rm = TRUE)
avg.mse.sc
# df.gap
df.mse = readRDS("./data/df.mse_tobacco_pred.Rds")
avg.mse.sc = mean(df.mse$mse.postT.raw, na.rm = TRUE)
avg.mse.dsc = mean(df.mse$mse.postT.TFDTW, na.rm = TRUE)
avg.mse.sc
avg.mse.dsc
# df.gap
df.mse = readRDS("./data/df.mse_germany_pred.Rds")
avg.mse.sc = mean(df.mse$mse.postT.raw, na.rm = TRUE)
avg.mse.dsc = mean(df.mse$mse.postT.TFDTW, na.rm = TRUE)
avg.mse.sc
avg.mse.dsc
# plot
df.target = readRDS("./data/df.target_basque_pred.Rds")
df.gap = readRDS("./data/df.gap_basque_pred.Rds")
df.quantile = df.gap %>%
group_by(time) %>%
summarise(quantile.sc.975 = quantile(gap.sc, 0.975, na.rm = T),
quantile.sc.025 = quantile(gap.sc, 0.025, na.rm = T),
quantile.dsc.975 = quantile(gap.dsc, 0.975, na.rm = T),
quantile.dsc.025 = quantile(gap.dsc, 0.025, na.rm = T)) %>%
mutate(group = "quantile")
color.sc = "#2ab7ca"
color.dsc = "#fe4a49"
# color.sc = "grey70"
# color.dsc = "grey30"
colors = c("TE (SC)" = color.sc,
"TE (DSC)" = color.dsc)
fills = c("95% Quantile (SC)" = color.sc,
"95% Quantile (DSC)" = color.dsc)
set.seed(20230812)
group.sample = sample(unique(df.gap$group), 100)
fig_basque = df.gap %>%
filter(group %in% group.sample) %>%
ggplot(aes(x = time, group = group)) +
annotate("rect", xmin = 1970, xmax = 1980,
ymin = -3, ymax = 3, alpha = .3) +
geom_line(aes(y = gap.sc), col = color.sc, alpha = 0.4) +
geom_line(aes(y = gap.dsc), col = color.dsc, alpha = 0.4) +
geom_ribbon(aes(ymin = quantile.sc.025,
ymax = quantile.sc.975,
fill="95% Quantile (SC)"),
data = df.quantile, alpha=0.5) +
geom_ribbon(aes(ymin = quantile.dsc.025,
ymax = quantile.dsc.975,
fill="95% Quantile (DSC)"),
data = df.quantile, alpha=0.5) +
geom_line(aes(y = gap.sc, color = "TE (SC)"),
data = df.target, size = 1) +
geom_line(aes(y = gap.dsc, color = "TE (DSC)"),
data = df.target, size = 1) +
scale_color_manual(name = NULL, values = colors) +
scale_fill_manual(name = NULL, values = fills) +
geom_vline(xintercept = 1970, linetype="dashed", col = "grey20") +
geom_hline(yintercept = 0, linetype="dashed", col = "grey20") +
annotate("text", x = 1975, y = 0.85,
label = "t = -6.05\nP < 0.0001", col = "grey20") +
annotate("text", x = 1969, y = 0.6, angle = 90,
label = "Treatment", col = "grey20") +
annotate("text", x = 1960, y = -0.5, label = "bar(MSE)[SC]==0.0469", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
annotate("text", x = 1960, y = -0.8, label = "bar(MSE)[DSC]==0.0333", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
coord_cartesian(xlim=c(1950, 1990), ylim = c(-1, 1)) +
xlab("Year") +
ylab("TE(y - Synthetic Control)") +
theme_bw() +
theme(legend.position = "none",
legend.box = "horizontal",
legend.background = element_rect(fill=NA))
# plot
df.target = readRDS("./data/df.target_tobacco_pred.Rds")
df.gap = readRDS("./data/df.gap_tobacco_pred.Rds")
df.quantile = df.gap %>%
group_by(time) %>%
summarise(quantile.sc.975 = quantile(gap.sc, 0.975, na.rm = T),
quantile.sc.025 = quantile(gap.sc, 0.025, na.rm = T),
quantile.dsc.975 = quantile(gap.dsc, 0.975, na.rm = T),
quantile.dsc.025 = quantile(gap.dsc, 0.025, na.rm = T)) %>%
mutate(group = "quantile")
df.quantile[29:31,4:5] = NA
color.sc = "#2ab7ca"
color.dsc = "#fe4a49"
# color.sc = "grey70"
# color.dsc = "grey30"
colors = c("TE (SC)" = color.sc,
"TE (DSC)" = color.dsc)
fills = c("95% Quantile (SC)" = color.sc,
"95% Quantile (DSC)" = color.dsc)
set.seed(20230812)
group.sample = sample(unique(df.gap$group), 100)
fig.placebo = df.gap %>%
filter(group %in% group.sample) %>%
ggplot(aes(x = time, group = group)) +
annotate("rect", xmin = 1989, xmax = 1999,
ymin = -60, ymax = 70, alpha = .3) +
geom_line(aes(y = gap.sc), col = color.sc, alpha = 0.4) +
geom_line(aes(y = gap.dsc), col = color.dsc, alpha = 0.4) +
geom_ribbon(aes(ymin = quantile.sc.025,
ymax = quantile.sc.975,
fill="95% Quantile (SC)"),
data = df.quantile, alpha=0.5) +
geom_ribbon(aes(ymin = quantile.dsc.025,
ymax = quantile.dsc.975,
fill="95% Quantile (DSC)"),
data = df.quantile, alpha=0.5) +
geom_line(aes(y = gap.sc, color = "TE (SC)"),
data = df.target, size = 1) +
geom_line(aes(y = gap.dsc, color = "TE (DSC)"),
data = df.target, size = 1) +
scale_color_manual(name = NULL, values = colors) +
scale_fill_manual(name = NULL, values = fills) +
geom_vline(xintercept = 1989, linetype="dashed", col = "grey20") +
geom_hline(yintercept = 0, linetype="dashed", col = "grey20") +
annotate("text", x = 1994, y = 33,
label = "t = -9.09\nP < 0.0001", col = "grey20") +
annotate("text", x = 1988, y = 25, angle = 90,
label = "Treatment", col = "grey20") +
annotate("text", x = 2005, y = -20, label = "bar(MSE)[SC]==149.15", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
annotate("text", x = 2005, y = -30, label = "bar(MSE)[DSC]==121.36", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
coord_cartesian(xlim=c(1969, 2009), ylim=c(-40,40)) +
xlab("Year") +
ylab("TE(y - Synthetic Control)") +
theme_bw() +
theme(legend.position = "none",
legend.box = "horizontal",
legend.background = element_rect(fill=NA))
set.seed(20220407)
df.target = readRDS("./data/df.target_germany_pred.Rds")
df.gap = readRDS("./data/df.gap_germany_pred.Rds")
df.quantile = df.gap %>%
group_by(time) %>%
summarise(quantile.sc.975 = quantile(gap.sc, 0.975, na.rm = T),
quantile.sc.025 = quantile(gap.sc, 0.025, na.rm = T),
quantile.dsc.975 = quantile(gap.dsc, 0.975, na.rm = T),
quantile.dsc.025 = quantile(gap.dsc, 0.025, na.rm = T)) %>%
mutate(group = "quantile")
color.sc = "#2ab7ca"
color.dsc = "#fe4a49"
# color.sc = "grey70"
# color.dsc = "grey30"
colors = c("Target TE (SC)" = color.sc,
"Target TE (DSC)" = color.dsc)
fills = c("95% Quantile (SC)" = color.sc,
"95% Quantile (DSC)" = color.dsc)
set.seed(20220407)
group.sample = sample(unique(df.gap$group), 100)
fig_germany = df.gap %>%
filter(group %in% group.sample) %>%
ggplot(aes(x = time, group = group)) +
annotate("rect", xmin = 1990, xmax = 2000,
ymin = -9000, ymax = 9000, alpha = .3) +
geom_line(aes(y = gap.sc), col = color.sc, alpha = 0.4) +
geom_line(aes(y = gap.dsc), col = color.dsc, alpha = 0.4) +
geom_ribbon(aes(ymin = quantile.sc.025,
ymax = quantile.sc.975,
fill="95% Quantile (SC)"),
data = df.quantile, alpha=0.5) +
geom_ribbon(aes(ymin = quantile.dsc.025,
ymax = quantile.dsc.975,
fill="95% Quantile (DSC)"),
data = df.quantile, alpha=0.5) +
geom_line(aes(y = gap.sc, color = "Target TE (SC)"),
data = df.target, size = 1) +
geom_line(aes(y = gap.dsc, color = "Target TE (DSC)"),
data = df.target, size = 1) +
scale_color_manual(name = NULL, values = colors) +
scale_fill_manual(name = NULL, values = fills) +
geom_vline(xintercept = 1990, linetype="dashed", col = "grey20") +
geom_hline(yintercept = 0, linetype="dashed", col = "grey20") +
annotate("text", x = 1995, y = 6800,
label = "t = -5.47\nP < 0.0001", col = "grey20") +
annotate("text", x = 1989, y = 4800, angle = 90,
label = "Treatment", col = "grey20") +
annotate("text", x = 2007, y = -3000, label = "bar(MSE)[SC]==2.47(M)", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
annotate("text", x = 2007, y = -5000, label = "bar(MSE)[DSC]==2.72(M)", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
coord_cartesian(xlim=c(1970, 2010),ylim=c(-8000,8000)) +
xlab("Year") +
ylab("Treatment Effect") +
theme_bw() +
theme(legend.position = c(0.25, 0.2),
legend.box = "horizontal",
legend.background = element_rect(fill=NA))
fig_all = ggpubr::ggarrange(fig_basque + ggpubr::rremove("ylab") +
ggpubr::rremove("xlab"),
fig_tobacco + ggpubr::rremove("ylab") +
ggpubr::rremove("xlab"),
fig_germany + ggpubr::rremove("ylab") +
ggpubr::rremove("xlab"),
labels = c("Basque Terrorism",
"California Tobacco",
"German Reunification"),
label.x = 0.1,
label.y = 0.9,
hjust = c(0, 0, 0),
font.label = list(size = 16, color = "grey20",
face = "bold"),
ncol = 1, nrow = 3,
# common.legend = TRUE, legend = "bottom",
align = "hv")
fig_all = ggpubr::annotate_figure(fig_all,
left = grid::textGrob("Treatment Effect (TE)",
rot = 90, vjust = 1,
gp = grid::gpar(cex = 1.3)),
bottom = grid::textGrob("Time",
gp = grid::gpar(cex = 1.3)))
ggsave("./figures/placebo_all_pred.pdf",
fig_all,  width = 7, height = 7,
units = "in", limitsize = FALSE)
# df.gap
df.mse = readRDS("./data/df.mse_tobacco_pred.Rds")
# plot
df.target = readRDS("./data/df.target_tobacco_pred.Rds")
df.gap = readRDS("./data/df.gap_tobacco_pred.Rds")
avg.mse.sc = mean(df.mse$mse.postT.raw, na.rm = TRUE)
avg.mse.dsc = mean(df.mse$mse.postT.TFDTW, na.rm = TRUE)
avg.mse.sc
avg.mse.dsc
# plot
df.target = readRDS("./data/df.target_tobacco_pred.Rds")
df.gap = readRDS("./data/df.gap_tobacco_pred.Rds")
df.quantile = df.gap %>%
group_by(time) %>%
summarise(quantile.sc.975 = quantile(gap.sc, 0.975, na.rm = T),
quantile.sc.025 = quantile(gap.sc, 0.025, na.rm = T),
quantile.dsc.975 = quantile(gap.dsc, 0.975, na.rm = T),
quantile.dsc.025 = quantile(gap.dsc, 0.025, na.rm = T)) %>%
mutate(group = "quantile")
df.quantile[29:31,4:5] = NA
color.sc = "#2ab7ca"
color.dsc = "#fe4a49"
# color.sc = "grey70"
# color.dsc = "grey30"
colors = c("TE (SC)" = color.sc,
"TE (DSC)" = color.dsc)
fills = c("95% Quantile (SC)" = color.sc,
"95% Quantile (DSC)" = color.dsc)
set.seed(20230812)
group.sample = sample(unique(df.gap$group), 100)
fig_tobacco = df.gap %>%
filter(group %in% group.sample) %>%
ggplot(aes(x = time, group = group)) +
annotate("rect", xmin = 1989, xmax = 1999,
ymin = -60, ymax = 70, alpha = .3) +
geom_line(aes(y = gap.sc), col = color.sc, alpha = 0.4) +
geom_line(aes(y = gap.dsc), col = color.dsc, alpha = 0.4) +
geom_ribbon(aes(ymin = quantile.sc.025,
ymax = quantile.sc.975,
fill="95% Quantile (SC)"),
data = df.quantile, alpha=0.5) +
geom_ribbon(aes(ymin = quantile.dsc.025,
ymax = quantile.dsc.975,
fill="95% Quantile (DSC)"),
data = df.quantile, alpha=0.5) +
geom_line(aes(y = gap.sc, color = "TE (SC)"),
data = df.target, size = 1) +
geom_line(aes(y = gap.dsc, color = "TE (DSC)"),
data = df.target, size = 1) +
scale_color_manual(name = NULL, values = colors) +
scale_fill_manual(name = NULL, values = fills) +
geom_vline(xintercept = 1989, linetype="dashed", col = "grey20") +
geom_hline(yintercept = 0, linetype="dashed", col = "grey20") +
annotate("text", x = 1994, y = 33,
label = "t = -9.09\nP < 0.0001", col = "grey20") +
annotate("text", x = 1988, y = 25, angle = 90,
label = "Treatment", col = "grey20") +
annotate("text", x = 2005, y = -20, label = "bar(MSE)[SC]==149.15", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
annotate("text", x = 2005, y = -30, label = "bar(MSE)[DSC]==121.36", parse = TRUE,
col = "grey20", size = 4, fontface = "bold") +
coord_cartesian(xlim=c(1969, 2009), ylim=c(-40,40)) +
xlab("Year") +
ylab("TE(y - Synthetic Control)") +
theme_bw() +
theme(legend.position = "none",
legend.box = "horizontal",
legend.background = element_rect(fill=NA))
fig_all = ggpubr::ggarrange(fig_basque + ggpubr::rremove("ylab") +
ggpubr::rremove("xlab"),
fig_tobacco + ggpubr::rremove("ylab") +
ggpubr::rremove("xlab"),
fig_germany + ggpubr::rremove("ylab") +
ggpubr::rremove("xlab"),
labels = c("Basque Terrorism",
"California Tobacco",
"German Reunification"),
label.x = 0.1,
label.y = 0.9,
hjust = c(0, 0, 0),
font.label = list(size = 16, color = "grey20",
face = "bold"),
ncol = 1, nrow = 3,
# common.legend = TRUE, legend = "bottom",
align = "hv")
fig_all = ggpubr::annotate_figure(fig_all,
left = grid::textGrob("Treatment Effect (TE)",
rot = 90, vjust = 1,
gp = grid::gpar(cex = 1.3)),
bottom = grid::textGrob("Time",
gp = grid::gpar(cex = 1.3)))
ggsave("./figures/placebo_all_pred.pdf",
fig_all,  width = 7, height = 7,
units = "in", limitsize = FALSE)
## Setup -----------------------------------------------------------------------
library(checkpoint)
checkpoint("2022-04-01")
library(parallel)
n.cores = detectCores()
library(tidyverse)
library(furrr)
plan(multisession, workers = n.cores - 1)
options(future.rng.onMisuse="ignore")
options(stringsAsFactors = FALSE)
source("./R/utility/misc.R")
source("./R/utility/TFDTW.R")
source("./R/utility/synth.R")
source("./R/utility/implement.R")
source("./R/utility/grid.search.R")
set.seed(20220407)
## Basque Terrorism Data -------------------------------------------------------
data(basque, package = "Synth")
data = basque
colnames(data)[1:4] = c("id", "unit", "time", "value")
data = data %>% mutate(invest_ratio = invest/value,
value_raw = value)
# rescale
df.rescale = data %>%
filter(time <= 1970) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "Basque Country (Pais Vasco)",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 17)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
select2 = combn(setdiff(ids, 17), 2, simplify = TRUE)[,1:100]
for (i in 1:ncol(select2)) {
data.temp = data %>% filter(!(id %in% c(select2[, i], 17)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
## Placebo ---------------------------------------------------------------------
folder = "./data/placebo/basque/"
file.list = as.list(list.files(folder))
pre.start = 7
pre.end = 16
post.start = 17
post.end = 26
# df.mse
df.mse = future_map2(
file.list,
as.list(1:length(file.list)),
~{
file.name = .x
data.id = .y
data.list = readRDS(paste0(folder, file.name))
mse = future_map2(
data.list,
as.list(names(data.list)),
~{
result.synth = .x[["results.TFDTW.synth"]]
grid.id = .y
mse = result.synth %>%
map(
~{
task = .
unit = task$dependent
scales = df.rescale %>% filter(unit == task$dependent)
value.min = scales$value.min
multiplier = scales$multiplier
value.true = task$res.synth.TFDTW$value/multiplier + value.min
value.sc = task$res.synth.raw$synthetic/multiplier + value.min
value.dsc = task$res.synth.TFDTW$synthetic/multiplier + value.min
gap.raw = value.true - value.true
gap.TFDTW = value.dsc - value.sc
data.frame(unit = unit,
mse.preT.raw = mean(gap.raw[pre.start:pre.end]^2, na.rm = T),
mse.preT.TFDTW = mean(gap.TFDTW[pre.start:pre.end]^2, na.rm = T),
mse.postT.raw = mean(gap.raw[post.start:post.end]^2, na.rm = T),
mse.postT.TFDTW = mean(gap.TFDTW[post.start:post.end]^2, na.rm = T))
}
) %>% do.call("rbind", .)
mse %>% mutate(grid.id = grid.id)
}
) %>% do.call("rbind", .)
mse$data.id = data.id
mse %>%
group_by(unit) %>%
top_n(-1, mse.preT.TFDTW) %>%
top_n(-1, grid.id)
}
) %>% do.call("rbind", .)
