t.interval = 1990:1996
n.t = length(t.interval)
n.datasets = nrow(df)/length(t.interval)
n.t
n.datasets
var.sc = df %>% group_by(unit) %>%
summarise(variance = var(gap_original, na.rm = TRUE)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
var.dsc = df %>% group_by(unit) %>%
summarise(variance = var(gap_new, na.rm = TRUE)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
f.value = var.dsc/var.sc
f.value = round(f.value, 4)
p.value = pf(f.value, DF.dsc,
DF.sc, lower.tail = TRUE)
p.value = round(p.value, 4)
f.value
var.dsc
var.sc
df %>%
group_by(unit) %>%
summarise(n.na = )
df %>%
group_by(time) %>%
summarise(n.na = sum(is.na(gap_original)))
df %>%
group_by(time) %>%
summarise(n.na = sum(is.na(gap_new)))
df = future_map2(
results,
as.list(1:length(results)),
~{
item = .x
index = .y
mse = future_map2(
item,
names(item),
~{
item = .x
id = .y
item$mse %>% mutate(id = id)
}
) %>%
do.call("rbind", .)
units = unique(mse$unit)
df.gap.list = NULL
for (i in 1:length(units)) {
target = units[[i]]
scores = mse %>%
filter(unit != target) %>%
group_by(id) %>%
summarise(percent = mean(log.ratio < 0),
p.value = t.test(log.ratio)$p.value)
max.percent = which(scores$percent == max(scores$percent))
min.p = which(scores$p.value[max.percent] == min(scores$p.value[max.percent])[1])[1]
opt.ind = as.numeric(scores$id[max.percent[min.p]])
df.gap.list[[i]] = data.frame(
unit = paste0("d", index, "-", target),
time = 1970:2000,
value = item[[opt.ind]]$results.TFDTW.synth[[target]]$res.synth.raw$value,
gap_original = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.raw,
gap_new = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.TFDTW
)
# df.gap.list[[i]] = item[[opt.ind]]$mse %>% filter(unit == target) #%>%
#mutate(unit = paste0("d", index, "-", target))
}
df.gap.list %>% do.call("rbind", .)
}
) %>%
do.call("rbind", .)
df = df %>% filter(time %in% 1990:1999)
df %>%
group_by(time) %>%
summarise(n.na = sum(is.na(gap_new)))
results = NULL
folder = "./data/placebo/basque/"
res.files = list.files(folder)
for (res.file in res.files) {
results = c(results, list(readRDS(paste0(folder, res.file))))
}
df = future_map2(
results,
as.list(1:length(results)),
~{
item = .x
index = .y
mse = future_map2(
item,
names(item),
~{
item = .x
id = .y
item$mse %>% mutate(id = id)
}
) %>%
do.call("rbind", .)
units = unique(mse$unit)
df.gap.list = NULL
for (i in 1:length(units)) {
target = units[[i]]
scores = mse %>%
filter(unit != target) %>%
group_by(id) %>%
summarise(percent = mean(log.ratio < 0),
p.value = t.test(log.ratio)$p.value)
max.percent = which(scores$percent == max(scores$percent))
min.p = which(scores$p.value[max.percent] == min(scores$p.value[max.percent])[1])[1]
opt.ind = as.numeric(scores$id[max.percent[min.p]])
df.gap.list[[i]] = data.frame(
unit = paste0("d", index, "-", target),
time = 1955:1997,
value = item[[opt.ind]]$results.TFDTW.synth[[target]]$res.synth.raw$value,
gap_original = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.raw,
gap_new = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.TFDTW
)
# df.gap.list[[i]] = item[[opt.ind]]$mse %>% filter(unit == target) #%>%
#mutate(unit = paste0("d", index, "-", target))
}
df.gap.list %>% do.call("rbind", .)
}
) %>%
do.call("rbind", .)
# ICC::ICCest(unit, log.ratio, data = df, CI.type = "S")
t.interval = 1971:1980
df = df %>% filter(time %in% t.interval)
n.t = length(t.interval)
n.datasets = nrow(df)/length(t.interval)
df_original = reshape2::dcast(df[c("unit", "time", "gap_original")],
time ~ unit, value.var = "gap_original")
value.icc.sc = irr::icc(
df_original[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.sc = (nrow(df_original) - 1)*value.icc.sc + 1
DF.sc = (dim(df_original)[1]*dim(df_original)[2])/vif.sc
df_new = reshape2::dcast(df[c("unit", "time", "gap_new")],
time ~ unit, value.var = "gap_new")
value.icc.dsc = irr::icc(
df_new[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.dsc = (nrow(df_new) - 1)*value.icc.dsc + 1
DF.dsc = (dim(df_new)[1]*dim(df_new)[2])/vif.dsc
var.sc = df %>% group_by(unit) %>%
summarise(variance = var(gap_original)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
var.dsc = df %>% group_by(unit) %>%
summarise(variance = var(gap_new)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
f.value = var.dsc/var.sc
f.value = round(f.value, 4)
p.value = pf(f.value, DF.dsc,
DF.sc, lower.tail = TRUE)
p.value = round(p.value, 4)
df %>%
group_by(time) %>%
summarise(n.na = sum(is.na(gap_new)))
results = NULL
folder = "./data/placebo/germany/"
res.files = list.files(folder)
for (res.file in res.files) {
results = c(results, list(readRDS(paste0(folder, res.file))))
}
df = future_map2(
results,
as.list(1:length(results)),
~{
item = .x
index = .y
mse = future_map2(
item,
names(item),
~{
item = .x
id = .y
item$mse %>% mutate(id = id)
}
) %>%
do.call("rbind", .)
units = unique(mse$unit)
df.gap.list = NULL
for (i in 1:length(units)) {
target = units[[i]]
scores = mse %>%
filter(unit != target) %>%
group_by(id) %>%
summarise(percent = mean(log.ratio < 0),
p.value = t.test(log.ratio)$p.value)
max.percent = which(scores$percent == max(scores$percent))
min.p = which(scores$p.value[max.percent] == min(scores$p.value[max.percent])[1])[1]
opt.ind = as.numeric(scores$id[max.percent[min.p]])
df.gap.list[[i]] = data.frame(
unit = paste0("d", index, "-", target),
time = 1960:2003,
value = item[[opt.ind]]$results.TFDTW.synth[[target]]$res.synth.raw$value,
gap_original = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.raw,
gap_new = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.TFDTW
)
# df.gap.list[[i]] = item[[opt.ind]]$mse %>% filter(unit == target) #%>%
#mutate(unit = paste0("d", index, "-", target))
}
df.gap.list %>% do.call("rbind", .)
}
) %>%
do.call("rbind", .)
df = df %>% filter(time %in% 1991:2000)
# ICC::ICCest(unit, gap_original, data = df, CI.type = "S")
df_original = reshape2::dcast(df[c("unit", "time", "gap_original")],
time ~ unit, value.var = "gap_original")
value.icc.sc = irr::icc(
df_original[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.sc = (nrow(df_original) - 1)*value.icc.sc + 1
DF.sc = (dim(df_original)[1]*dim(df_original)[2])/vif.sc
df_new = reshape2::dcast(df[c("unit", "time", "gap_new")],
time ~ unit, value.var = "gap_new")
value.icc.dsc = irr::icc(
df_new[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.dsc = (nrow(df_new) - 1)*value.icc.dsc + 1
DF.dsc = (dim(df_new)[1]*dim(df_new)[2])/vif.dsc
# var.dsc = var(df$gap_new, na.rm = TRUE)
# var.sc = var(df$gap_original, na.rm = TRUE)
t.interval = 1991:2000
n.t = length(t.interval)
n.datasets = nrow(df)/length(t.interval)
var.sc = df %>% group_by(unit) %>%
summarise(variance = var(gap_original)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
var.dsc = df %>% group_by(unit) %>%
summarise(variance = var(gap_new)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
f.value = var.dsc/var.sc
f.value = round(f.value, 4)
p.value = pf(f.value, DF.dsc,
DF.sc, lower.tail = TRUE)
p.value = round(p.value, 4)
df %>%
group_by(time) %>%
summarise(n.na = sum(is.na(gap_new)))
library(tidyverse)
library(furrr)
plan(multisession, workers = 8)
options(future.rng.onMisuse="ignore")
options(stringsAsFactors = FALSE)
source("./R/misc.R")
source("./R/TFDTW.R")
source("./R/synth.R")
source("./R/implement.R")
source("./R/simulate.R")
source("./R/grid.search.R")
set.seed(20220407)
## Germany Reunification Data --------------------------------------------------
data = readRDS("./data/repgermany.Rds")
colnames(data)[1:4] = c("id", "unit", "time", "value")
data = data %>% mutate(value_raw = value)
# rescale
df.rescale = data %>%
filter(time <= 1990) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
data = readRDS("./data/repgermany.Rds")
colnames(data)[1:4] = c("id", "unit", "time", "value")
data = data %>% mutate(value_raw = value)
# rescale
df.rescale = data %>%
filter(time <= 1990) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "West Germany",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 7)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
library(tidyverse)
library(furrr)
plan(multisession, workers = 8)
options(future.rng.onMisuse="ignore")
options(stringsAsFactors = FALSE)
source("./R/misc.R")
source("./R/TFDTW.R")
source("./R/synth.R")
source("./R/implement.R")
source("./R/grid.search.R")
set.seed(20220407)
load("./data/smoking.rda")
prop99 = read.csv("./data/prop99.csv")
exclude_states = c("Massachusetts", "Arizona", "Oregon", "Florida",
"Alaska", "Hawaii", "Maryland", "Michigan",
"New Jersey", "New York",
"Washington", "District of Columbia")
include_states = sort(setdiff(unique(prop99$LocationDesc),
exclude_states))
states = data.frame(id = 1:length(include_states),
unit = include_states)
smoking = smoking %>% mutate_all(as.numeric)
colnames(smoking)[1:3] = c("id", "time", "value")
smoking = right_join(states, smoking, by = "id")
smoking = smoking %>%
mutate(value_raw = value,
age15to24 = age15to24*100)
data = smoking
# rescale
df.rescale = data %>%
filter(time <= 1989) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "California",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
#         legend.box = "horizontal",
#         legend.background = element_rect(fill=NA))
#
# # ggsave("./figures/placebo_tobacco_1103.pdf",
# #        fig_tobacco, width = 8, height = 6,
# #        units = "in", limitsize = FALSE)
#
#
#
# ## Placebo v2 ------------------------------------------------------------------
results = NULL
folder = "./data/placebo/tobacco/"
res.files = list.files(folder)
for (res.file in res.files) {
results = c(results, list(readRDS(paste0(folder, res.file))))
}
df = future_map2(
results,
as.list(1:length(results)),
~{
item = .x
index = .y
mse = future_map2(
item,
names(item),
~{
item = .x
id = .y
item$mse %>% mutate(id = id)
}
) %>%
do.call("rbind", .)
units = unique(mse$unit)
df.gap.list = NULL
for (i in 1:length(units)) {
target = units[[i]]
scores = mse %>%
filter(unit != target) %>%
group_by(id) %>%
summarise(percent = mean(log.ratio < 0),
p.value = t.test(log.ratio)$p.value)
max.percent = which(scores$percent == max(scores$percent))
min.p = which(scores$p.value[max.percent] == min(scores$p.value[max.percent])[1])[1]
opt.ind = as.numeric(scores$id[max.percent[min.p]])
df.gap.list[[i]] = data.frame(
unit = paste0("d", index, "-", target),
time = 1970:2000,
value = item[[opt.ind]]$results.TFDTW.synth[[target]]$res.synth.raw$value,
gap_original = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.raw,
gap_new = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.TFDTW
)
# df.gap.list[[i]] = item[[opt.ind]]$mse %>% filter(unit == target) #%>%
#mutate(unit = paste0("d", index, "-", target))
}
df.gap.list %>% do.call("rbind", .)
}
) %>%
do.call("rbind", .)
df2 = df
df = df %>% filter(time %in% 1990:1996)
df_original = reshape2::dcast(df[c("unit", "time", "gap_original")],
time ~ unit, value.var = "gap_original")
value.icc.sc = irr::icc(
df_original[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
install.packages("irr")
df_original = reshape2::dcast(df[c("unit", "time", "gap_original")],
time ~ unit, value.var = "gap_original")
value.icc.sc = irr::icc(
df_original[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.sc = (nrow(df_original) - 1)*value.icc.sc + 1
DF.sc = (dim(df_original)[1]*dim(df_original)[2])/vif.sc
df_new = reshape2::dcast(df[c("unit", "time", "gap_new")],
time ~ unit, value.var = "gap_new")
value.icc.dsc = irr::icc(
df_new[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.dsc = (nrow(df_new) - 1)*value.icc.dsc + 1
DF.dsc = (dim(df_new)[1]*dim(df_new)[2])/vif.dsc
DF.sc
DF.dsc
t.interval = 1990:1996
n.t = length(t.interval)
n.datasets = nrow(df)/length(t.interval)
var.sc = df %>% group_by(unit) %>%
summarise(variance = var(gap_original, na.rm = TRUE)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
var.dsc = df %>% group_by(unit) %>%
summarise(variance = var(gap_new, na.rm = TRUE)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
f.value = var.dsc/var.sc
f.value = round(f.value, 4)
p.value = pf(f.value, DF.dsc,
DF.sc, lower.tail = TRUE)
p.value = round(p.value, 4)
f.value
p.value
df = df2
df = df %>% filter(time %in% 1990:1999)
df_original = reshape2::dcast(df[c("unit", "time", "gap_original")],
time ~ unit, value.var = "gap_original")
value.icc.sc = irr::icc(
df_original[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.sc = (nrow(df_original) - 1)*value.icc.sc + 1
DF.sc = (dim(df_original)[1]*dim(df_original)[2])/vif.sc
df_new = reshape2::dcast(df[c("unit", "time", "gap_new")],
time ~ unit, value.var = "gap_new")
value.icc.dsc = irr::icc(
df_new[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.dsc = (nrow(df_new) - 1)*value.icc.dsc + 1
DF.dsc = (dim(df_new)[1]*dim(df_new)[2])/vif.dsc
t.interval = 1990:1996
n.t = length(t.interval)
n.datasets = nrow(df)/length(t.interval)
var.sc = df %>% group_by(unit) %>%
summarise(variance = var(gap_original, na.rm = TRUE)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
var.dsc = df %>% group_by(unit) %>%
summarise(variance = var(gap_new, na.rm = TRUE)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
f.value = var.dsc/var.sc
f.value = round(f.value, 4)
p.value = pf(f.value, DF.dsc,
DF.sc, lower.tail = TRUE)
p.value = round(p.value, 4)
f.value
p.value
