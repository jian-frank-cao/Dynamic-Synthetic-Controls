data = reshape2::melt(data, id.vars = 1)
data_monthly = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, month) %>%
# summarise(value = mean(value, na.rm = T)) %>%
summarise(value = first(value)) %>%
# summarise(value = last(value)) %>%
mutate(time = 1:155,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "month")) %>%
data.frame(.)
View(data_monthly)
View(data)
data = readRDS("./data/bond.Rds")
data = reshape2::melt(data, id.vars = 1)
data_monthly = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, month) %>%
# summarise(value = mean(value, na.rm = T)) %>%
summarise(value = first(value)) %>%
# summarise(value = last(value)) %>%
mutate(time = 1:155,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "month")) %>%
data.frame(.)
library(checkpoint)
checkpoint("2022-04-01")
library(parallel)
n.cores = detectCores()
library(tidyverse)
library(furrr)
plan(multisession, workers = n.cores - 1)
options(future.rng.onMisuse="ignore")
options(stringsAsFactors = FALSE)
source("./R/utility/misc.R")
source("./R/utility/TFDTW.R")
source("./R/utility/synth.R")
source("./R/utility/implement.R")
source("./R/utility/grid.search.R")
set.seed(20220407)
## Results ---------------------------------------------------------------------
folder = "./data/bond2/"
file.list = list.files(folder)
results = NULL
for (file in file.list) {
print(file)
df = readRDS(paste0(folder, file))
treat_time = as.numeric(strsplit(strsplit(file, "[.]")[[1]][1], "_")[[1]][2])
mse = future_map2(
as.list(1:length(df)),
df,
~{
id = .x
item = .y
item$mse$id = id
item$mse$diff = 0
item$mse$error20 = 0
for (i in 1:4) {
unit = item$mse$unit[i]
error = (item$results.TFDTW.synth[[unit]]$res.synth.raw$value -
item$results.TFDTW.synth[[unit]]$res.synth.TFDTW$synthetic)
difference = (item$results.TFDTW.synth[[unit]]$res.synth.raw$synthetic -
item$results.TFDTW.synth[[unit]]$res.synth.TFDTW$synthetic)
msd = mean((difference[treat_time:(treat_time + 23)])^2, na.rm = TRUE)
item$mse$diff[i] = msd
error20 = mean((error[(treat_time-20):(treat_time-1)])^2, na.rm = TRUE)
item$mse$error20[i] = error20
}
item$mse
}
) %>%
do.call("rbind", .)
mse$file = file
results[[file]] = mse
}
file
strsplit(file, "[.]")
strsplit(file, "[.]")[[1]][1]
strsplit(strsplit(file, "[.]")[[1]][1], "_")[[1]]
results = NULL
for (file in file.list) {
print(file)
df = readRDS(paste0(folder, file))
treat_time = as.numeric(strsplit(strsplit(file, "[.]")[[1]][1], "_")[[1]][3])
mse = future_map2(
as.list(1:length(df)),
df,
~{
id = .x
item = .y
item$mse$id = id
item$mse$diff = 0
item$mse$error20 = 0
for (i in 1:4) {
unit = item$mse$unit[i]
error = (item$results.TFDTW.synth[[unit]]$res.synth.raw$value -
item$results.TFDTW.synth[[unit]]$res.synth.TFDTW$synthetic)
difference = (item$results.TFDTW.synth[[unit]]$res.synth.raw$synthetic -
item$results.TFDTW.synth[[unit]]$res.synth.TFDTW$synthetic)
msd = mean((difference[treat_time:(treat_time + 23)])^2, na.rm = TRUE)
item$mse$diff[i] = msd
error20 = mean((error[(treat_time-20):(treat_time-1)])^2, na.rm = TRUE)
item$mse$error20[i] = error20
}
item$mse
}
) %>%
do.call("rbind", .)
mse$file = file
results[[file]] = mse
}
results = results %>%
do.call("rbind", .) %>%
`rownames<-`(NULL)
View(results)
saveRDS(results, "./data/bond_results2.Rds")
target = "TIP"
mse = results %>%
filter(unit == target) %>%
group_by(file) %>%
filter(error20 == min(error20)) %>%
filter(id == min(id))
View(mse)
data = readRDS("./data/bond.Rds")
data = reshape2::melt(data, id.vars = 1)
data_monthly = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, month) %>%
# summarise(value = mean(value, na.rm = T)) %>%
summarise(value = first(value)) %>%
# summarise(value = last(value)) %>%
mutate(time = 1:155,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "month")) %>%
data.frame(.)
data_monthly %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line() +
geom_vline(xintercept = 123) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 121
id = 75
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_first_", treat_t, ".Rds"))[[id]]
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 122
id = 110
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 123
id = 1
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
target
treat_t = 124
id = 106
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 125
id = 36
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 126
id = 1
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 127
id = 5
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 128
id = 5
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 129
id = 5
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 130
id = 5
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
data_monthly = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, month) %>%
# summarise(value = mean(value, na.rm = T)) %>%
# summarise(value = first(value)) %>%
summarise(value = last(value)) %>%
mutate(time = 1:155,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "month")) %>%
data.frame(.)
treat_t = 121
id = 110
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 122
id = 36
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 123
id = 36
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 124
id = 36
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 125
id = 141
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 126
id = 141
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 127
id = 36
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 128
id = 71
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
