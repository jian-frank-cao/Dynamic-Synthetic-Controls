var.sc = sum.sq.sc/DF.sc
mse.aov.dsc = aov(mse.dsc ~ data.id*unit, res)
summary.aov.dsc = summary(mse.aov.dsc)
DF.dsc = summary.aov.dsc[[1]]$Df %>% sum
sum.sq.dsc = summary.aov.dsc[[1]]$`Sum Sq` %>% sum
var.dsc = sum.sq.dsc/DF.dsc
pf(var.dsc/var.sc, DF.dsc, DF.sc, lower.tail = TRUE)*2
var.dsc/var.sc
DF.dsc
rbind(data.frame(value = res$mse.sc,
method = "sc"),
data.frame(value = res$mse.dsc,
method = "dsc")) %>%
ggplot(aes(x = method, y = value)) +
geom_boxplot()
df = df.basque
res = df %>%
group_by(unit) %>%
summarise(mse.sc = mean(gap_original^2, na.rm = T),
mse.dsc = mean(gap_new^2, na.rm = T))
res = res %>%
mutate(
data.id = str_split(unit, "-", simplify = TRUE)[,1],
unit = str_split(unit, "-", simplify = TRUE)[,2]
)
res = res %>%
mutate(log.ratio = log(mse.dsc/mse.sc))
t.test(res$log.ratio)
mse.aov.sc = aov(mse.sc ~ data.id*unit, res)
summary.aov.sc = summary(mse.aov.sc)
DF.sc = summary.aov.sc[[1]]$Df %>% sum
sum.sq.sc = summary.aov.sc[[1]]$`Sum Sq` %>% sum
var.sc = sum.sq.sc/DF.sc
mse.aov.dsc = aov(mse.dsc ~ data.id*unit, res)
summary.aov.dsc = summary(mse.aov.dsc)
DF.dsc = summary.aov.dsc[[1]]$Df %>% sum
sum.sq.dsc = summary.aov.dsc[[1]]$`Sum Sq` %>% sum
var.dsc = sum.sq.dsc/DF.dsc
pf(var.dsc/var.sc, DF.dsc, DF.sc, lower.tail = TRUE)*2
rbind(data.frame(value = res$mse.sc,
method = "sc"),
data.frame(value = res$mse.dsc,
method = "dsc")) %>%
ggplot(aes(x = method, y = value)) +
geom_boxplot()
boxplot(res$log.ratio)
var.dsc/var.sc
t.test(res$log.ratio)
df = df.germany
df_original = reshape2::dcast(df[c("unit", "time", "gap_original")],
time ~ unit, value.var = "gap_original")
value.icc.sc = irr::icc(
df_original[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.sc = (nrow(df_original) - 1)*value.icc.sc + 1
DF.sc = (dim(df_original)[1]*dim(df_original)[2])/vif.sc
df_new = reshape2::dcast(df[c("unit", "time", "gap_new")],
time ~ unit, value.var = "gap_new")
value.icc.dsc = irr::icc(
df_new[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
vif.dsc = (nrow(df_new) - 1)*value.icc.dsc + 1
DF.dsc = (dim(df_new)[1]*dim(df_new)[2])/vif.dsc
t.interval = 1991:2000
n.t = length(t.interval)
n.datasets = nrow(df)/length(t.interval)
var.sc = df %>% group_by(unit) %>%
summarise(variance = var(gap_original)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
var.dsc = df %>% group_by(unit) %>%
summarise(variance = var(gap_new)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
f.value = var.dsc/var.sc
f.value = round(f.value, 4)
p.value = pf(f.value, DF.dsc,
DF.sc, lower.tail = TRUE)
f.value
p.value
library(tidyverse)
library(furrr)
plan(multisession, workers = 8)
options(future.rng.onMisuse="ignore")
options(stringsAsFactors = FALSE)
source("./R/misc.R")
source("./R/TFDTW.R")
source("./R/synth.R")
source("./R/implement.R")
source("./R/simulate.R")
source("./R/grid.search.R")
set.seed(20220407)
results = NULL
beta = 1
folder = "./data/res_sim/1006/"
res.files = list.files(folder)
for (res.file in res.files) {
results = c(results, list(readRDS(paste0(folder, res.file))))
}
length = 100
shock = 10
treat_time = 60
n_mse = 10
causal_effect = c(rep(0, treat_time),
seq(0, shock, length.out = round(0.1*length)),
rep(shock, round(0.9*length - treat_time)))
# placebo test figure
res = future_map2(
results,
as.list(1:length(results)),
~{
item = .x
id = .y
# neg.ratio = lapply(item, "[[", "neg.ratio") %>% do.call("c", .)
# # neg.ratio.rank = rank(neg.ratio, ties.method = "max")
# ind.max.neg.ratio = which(neg.ratio == max(neg.ratio, na.rm = T))
# p.value = lapply(item, "[[", "p.value") %>% do.call("c", .) %>% .[ind.max.neg.ratio]
# # p.value.rank = rank(1 - p.value, ties.method = "max")
# ind.min.p.value = which(p.value == min(p.value, na.rm = T))[1]
# # mse.pre = lapply(item, "[[", "mse") %>% do.call("rbind", .) %>%
# #   filter(unit == "A") %>% .[["mse.preT.TFDTW"]] %>% .[ind.max.neg.ratio]
# # mse.pre.rank = rank(1 - mse.pre, ties.method = "max")
# # score = neg.ratio.rank*3 + p.value.rank*2 + mse.pre.rank
# # ind = which(score == max(score, na.rm = T))[1]
# ind = ind.max.neg.ratio[1]
neg.ratio = lapply(item, "[[", "neg.ratio") %>% do.call("c", .)
ind.max.neg.ratio = which(neg.ratio == max(neg.ratio, na.rm = T))
p.value = lapply(item, "[[", "p.value") %>% do.call("c", .) %>% .[ind.max.neg.ratio]
ind.min.p.value = which(p.value == min(p.value, na.rm = T))
# mse.pre = lapply(item, "[[", "mse") %>% do.call("rbind", .) %>%
#   filter(unit == "A") %>% .[["mse.preT.TFDTW"]] %>% .[ind.max.neg.ratio]
# mse.pre.rank = rank(1 - mse.pre, ties.method = "max")
# score = neg.ratio.rank*3 + p.value.rank*2 + mse.pre.rank
# ind = which(score == max(score, na.rm = T))[1]
ind = ind.max.neg.ratio[ind.min.p.value[1]]
synth_original = item[[ind]][["res.synth.target.raw"]][["synthetic"]]
synth_new = item[[ind]][["res.synth.target.TFDTW"]][["synthetic"]]
value_raw = item[[ind]][["res.synth.target.raw"]][["value"]]
gap_original = value_raw - synth_original
gap_new = value_raw - synth_new
diff_original = value_raw - synth_original - causal_effect
diff_new = value_raw - synth_new - causal_effect
mse_original = mean((diff_original)[treat_time:(treat_time + n_mse)]^2, rm.na = T)
mse_new = mean((diff_new)[treat_time:(treat_time + n_mse)]^2, rm.na = T)
mse = data.frame(mse_original = mse_original,
mse_new = mse_new,
log_ratio = log(mse_new/mse_original))
list(df = data.frame(time = 0:(length(value_raw)-1),
id = id,
value_raw = value_raw,
synth_original = synth_original,
synth_new = synth_new,
gap_origin = gap_original,
gap_new = gap_new,
diff_original = diff_original,
diff_new = diff_new),
mse = mse)
}
)
mse = lapply(res, "[[", "mse") %>% do.call("rbind", .)
t.test(mse$log_ratio)
df = lapply(res, "[[", "df") %>% do.call("rbind", .)
?psych::ICC
rownames(sf) <- paste("S",1:6,sep="")
sf <- matrix(c(
9,    2,   5,    8,
6,    1,   3,    2,
8,    4,   6,    8,
7,    1,   2,    6,
10,   5,   6,    9,
6,   2,   4,    7),ncol=4,byrow=TRUE)
colnames(sf) <- paste("J",1:4,sep="")
rownames(sf) <- paste("S",1:6,sep="")
sf
ICC(sf,lmer=FALSE)
library(psych)
ICC(sf,lmer=FALSE)
ICC(sf,lmer=FALSE)
sf.df <- melt(sf, varnames=c("Subject", "Rater"))
library(reshape)
sf.df <- melt(sf, varnames=c("Subject", "Rater"))
sf.df
aov(value ~ Subject*Rater, sf.df)
res.aov = aov(value ~ Subject*Rater, sf.df)
summary(res.aov)
res.aov = aov(value ~ Subject*Rater, rbind(sf.df,sf.df,sf.df))
summary(res.aov)
res.aov = aov(value ~ Subject*Rater, rbind(sf.df,sf.df+1,sf.df+2))
library(tidyverse)
res.aov = aov(value ~ Subject*Rater, rbind(sf.df,sf.df %>% mutate(value = value + 1),sf.df %>% mutate(value = value + 2))
res.aov = aov(value ~ Subject*Rater, rbind(sf.df,sf.df %>% mutate(value = value + 1),sf.df %>% mutate(value = value + 2)))
summary(res.aov)
res.aov = aov(value ~ Subject*Rater, rbind(sf.df,sf.df %>% mutate(value = value + 1),sf.df %>% mutate(value = value + 2)))
summary(res.aov)
sf.df <- melt(sf, varnames=c("Subject", "Rater"))
sf.df2 = rbind(sf.df,sf.df %>% mutate(value = value + 1),sf.df %>% mutate(value = value + 2))
res.aov = aov(value ~ Subject*Rater, sf.df2)
summary(res.aov)
res.aov = aov(value ~ Subject, sf.df2)
summary(res.aov)
ICC(sf,lmer=FALSE)
res.aov = aov(value ~ Subject*Rater, sf.df)
res.aov = aov(value ~ Subject, sf.df)
res.aov = aov(value ~ Subject*Rater, sf.df)
summary(res.aov)
res.aov = aov(value ~ Subject, sf.df)
summary(res.aov)
?ICC
res.aov = aov(value ~ Subject*Rater, sf.df2)
summary(res.aov)
sf.df2 = sf.df2 %>% mutate(unit = paste0(Subject, Rater, "-"))
View(sf.df2)
sf.df2 = rbind(sf.df,sf.df %>% mutate(value = value + 1),sf.df %>% mutate(value = value + 2))
sf.df2 = sf.df2 %>% mutate(unit = paste0(Subject, "-", Rater))
View(sf.df2)
res.aov = aov(value ~ unit, sf.df2)
summary(res.aov)
?irr::icc
rnorm(nrow(sf))
sf.df <- melt(sf, varnames=c("Subject", "Rater"))
sf.df2 = rbind(sf.df,sf.df %>% mutate(value = value + rnorm(nrow(sf))),sf.df %>% mutate(value = value + 2*rnorm(nrow(sf))))
sf.df2 = sf.df2 %>% mutate(unit = paste0(Subject, "-", Rater))
res.aov = aov(value ~ Subject*Rater, sf.df2)
summary(res.aov)
res.aov = aov(value ~ unit, sf.df2)
summary(res.aov)
install.packages("regclass")
model = lm(value ~ Subject*Rater, data = sf.df2)
regclass::VIF(model)
model = lm(value ~ unit, data = sf.df2)
regclass::VIF(model)
?regclass::VIF
View(sf.df2)
sf.df <- melt(sf, varnames=c("Subject", "Rater"))
sf.df2 = rbind(sf.df %>% mutate(id = 1),
sf.df %>% mutate(value = value + rnorm(nrow(sf)), id = 2),
sf.df %>% mutate(value = value + 2*rnorm(nrow(sf)), id = 3))
sf.df2 = sf.df2 %>% mutate(unit = paste0(Subject, "-", Rater))
sf.df3 = reshape2::dcast(sf.df2[c("id", "unit", "value")],
id ~ unit, value.var = "value")
View(sf.df3)
sf.df <- melt(sf, varnames=c("Subject", "Rater"))
sf.df2 = rbind(sf.df %>% mutate(id = 1),
sf.df %>% mutate(value = value + rnorm(nrow(sf)), id = 2),
sf.df %>% mutate(value = value + 2*rnorm(nrow(sf)), id = 3),
sf.df %>% mutate(value = value + 2*rnorm(nrow(sf)), id = 4),
sf.df %>% mutate(value = value + 2*rnorm(nrow(sf)), id = 5),
sf.df %>% mutate(value = value + 2*rnorm(nrow(sf)), id = 6),
sf.df %>% mutate(value = value + 2*rnorm(nrow(sf)), id = 7))
sf.df2 = sf.df2 %>% mutate(unit = paste0(Subject, "-", Rater))
sf.df3 = reshape2::dcast(sf.df2[c("id", "unit", "value")],
id ~ unit, value.var = "value")
View(sf.df3)
model = lm(value ~ Subject*Rater, data = sf.df2)
regclass::VIF(model)
model = lm(value ~ unit, data = sf.df2)
regclass::VIF(model)
irr::icc(
sf.df3[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
res.icc = irr::icc(
sf.df3[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
res.icc = irr::icc(
sf.df3[,-1], model = "twoway",
type = "agreement", unit = "single"
)$value
(nrow(sf.df3) - 1)*res.icc + 1
sf.df3 = reshape2::dcast(sf.df2[c("Subject", "unit", "value")],
id ~ unit, value.var = "value")
sf.df3 = reshape2::dcast(sf.df2[c("Subject", "unit", "value")],
Subject ~ unit, value.var = "value")
sf.df3 = reshape2::dcast(sf.df2[c("id", "unit", "value")],
id ~ unit, value.var = "value")
res.icc = irr::icc(
sf.df3[,-1], model = "oneway",
type = "c", unit = "single"
)$value
(nrow(sf.df3) - 1)*res.icc + 1
model = lm(value ~ Subject*Rater, data = sf.df2)
regclass::VIF(model)
model = lm(value ~ unit, data = sf.df2)
regclass::VIF(model)
model = lm(value ~ Subject + Rater, data = sf.df2)
regclass::VIF(model)
res.aov = aov(value ~ Subject*Rater*id, sf.df2)
summary(res.aov)
res.aov = aov(value ~ Subject*Rater, sf.df2)
summary(res.aov)
View(sf.df2)
model = lm(value ~ Subject*Rater, data = sf.df2)
regclass::VIF(model)
target = ((MST-MSI)/(L*K) + (MSJ-MSI)/(L*N) + (MSI-MSE)/(L))
MST = 108.61
MSJ = 227.40
MSI = 7.14
MSE = 3.55
L = 7
K = 4
N = 6
target = ((MST-MSI)/(L*K) + (MSJ-MSI)/(L*N) + (MSI-MSE)/(L))
target
target/(target + MSE)
ICC(sf,lmer=FALSE)
library(tidyverse)
library(furrr)
plan(multisession, workers = 8)
options(future.rng.onMisuse="ignore")
options(stringsAsFactors = FALSE)
source("./R/misc.R")
source("./R/TFDTW.R")
source("./R/synth.R")
source("./R/implement.R")
source("./R/simulate.R")
source("./R/grid.search.R")
set.seed(20220407)
results = NULL
beta = 1
folder = "./data/res_sim/1006/"
res.files = list.files(folder)
for (res.file in res.files) {
results = c(results, list(readRDS(paste0(folder, res.file))))
}
length = 100
shock = 10
treat_time = 60
n_mse = 10
causal_effect = c(rep(0, treat_time),
seq(0, shock, length.out = round(0.1*length)),
rep(shock, round(0.9*length - treat_time)))
# placebo test figure
res = future_map2(
results,
as.list(1:length(results)),
~{
item = .x
id = .y
# neg.ratio = lapply(item, "[[", "neg.ratio") %>% do.call("c", .)
# # neg.ratio.rank = rank(neg.ratio, ties.method = "max")
# ind.max.neg.ratio = which(neg.ratio == max(neg.ratio, na.rm = T))
# p.value = lapply(item, "[[", "p.value") %>% do.call("c", .) %>% .[ind.max.neg.ratio]
# # p.value.rank = rank(1 - p.value, ties.method = "max")
# ind.min.p.value = which(p.value == min(p.value, na.rm = T))[1]
# # mse.pre = lapply(item, "[[", "mse") %>% do.call("rbind", .) %>%
# #   filter(unit == "A") %>% .[["mse.preT.TFDTW"]] %>% .[ind.max.neg.ratio]
# # mse.pre.rank = rank(1 - mse.pre, ties.method = "max")
# # score = neg.ratio.rank*3 + p.value.rank*2 + mse.pre.rank
# # ind = which(score == max(score, na.rm = T))[1]
# ind = ind.max.neg.ratio[1]
neg.ratio = lapply(item, "[[", "neg.ratio") %>% do.call("c", .)
ind.max.neg.ratio = which(neg.ratio == max(neg.ratio, na.rm = T))
p.value = lapply(item, "[[", "p.value") %>% do.call("c", .) %>% .[ind.max.neg.ratio]
ind.min.p.value = which(p.value == min(p.value, na.rm = T))
# mse.pre = lapply(item, "[[", "mse") %>% do.call("rbind", .) %>%
#   filter(unit == "A") %>% .[["mse.preT.TFDTW"]] %>% .[ind.max.neg.ratio]
# mse.pre.rank = rank(1 - mse.pre, ties.method = "max")
# score = neg.ratio.rank*3 + p.value.rank*2 + mse.pre.rank
# ind = which(score == max(score, na.rm = T))[1]
ind = ind.max.neg.ratio[ind.min.p.value[1]]
synth_original = item[[ind]][["res.synth.target.raw"]][["synthetic"]]
synth_new = item[[ind]][["res.synth.target.TFDTW"]][["synthetic"]]
value_raw = item[[ind]][["res.synth.target.raw"]][["value"]]
gap_original = value_raw - synth_original
gap_new = value_raw - synth_new
diff_original = value_raw - synth_original - causal_effect
diff_new = value_raw - synth_new - causal_effect
mse_original = mean((diff_original)[treat_time:(treat_time + n_mse)]^2, rm.na = T)
mse_new = mean((diff_new)[treat_time:(treat_time + n_mse)]^2, rm.na = T)
mse = data.frame(mse_original = mse_original,
mse_new = mse_new,
log_ratio = log(mse_new/mse_original))
list(df = data.frame(time = 0:(length(value_raw)-1),
id = id,
value_raw = value_raw,
synth_original = synth_original,
synth_new = synth_new,
gap_origin = gap_original,
gap_new = gap_new,
diff_original = diff_original,
diff_new = diff_new),
mse = mse)
}
)
mse = lapply(res, "[[", "mse") %>% do.call("rbind", .)
t.test(mse$log_ratio)
df = lapply(res, "[[", "df") %>% do.call("rbind", .)
df2 =df
df = df %>% filter(time %in% 60:69)
View(df)
results = NULL
folder = "./data/placebo/tobacco/"
res.files = list.files(folder)
for (res.file in res.files) {
results = c(results, list(readRDS(paste0(folder, res.file))))
}
df = future_map2(
results,
as.list(1:length(results)),
~{
item = .x
index = .y
mse = future_map2(
item,
names(item),
~{
item = .x
id = .y
item$mse %>% mutate(id = id)
}
) %>%
do.call("rbind", .)
units = unique(mse$unit)
df.gap.list = NULL
for (i in 1:length(units)) {
target = units[[i]]
scores = mse %>%
filter(unit != target) %>%
group_by(id) %>%
summarise(percent = mean(log.ratio < 0),
p.value = t.test(log.ratio)$p.value)
max.percent = which(scores$percent == max(scores$percent))
min.p = which(scores$p.value[max.percent] == min(scores$p.value[max.percent])[1])[1]
opt.ind = as.numeric(scores$id[max.percent[min.p]])
df.gap.list[[i]] = data.frame(
unit = paste0("d", index, "-", target),
time = 1970:2000,
value = item[[opt.ind]]$results.TFDTW.synth[[target]]$res.synth.raw$value,
gap_original = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.raw,
gap_new = item[[opt.ind]]$results.TFDTW.synth[[target]]$gap.TFDTW
)
# df.gap.list[[i]] = item[[opt.ind]]$mse %>% filter(unit == target) #%>%
#mutate(unit = paste0("d", index, "-", target))
}
df.gap.list %>% do.call("rbind", .)
}
) %>%
do.call("rbind", .)
df = df %>% filter(time %in% 1990:1997)
View(df)
df = df %>%
mutate(
data.id = str_split(unit, "-", simplify = TRUE)[,1],
unit = str_split(unit, "-", simplify = TRUE)[,2]
)
df3 = df
View(df)
res.aov = aov(gap_original ~ unit*data.id, df)
summary(res.aov)
MST = 34728
MSJ = 28
MSI = 26
MSE = 34
L = 10
K = 39
N = 38
target = ((MST-MSI)/(L*K) + (MSJ-MSI)/(L*N) + (MSI-MSE)/(L))
target/(target + MSE)
View(df)
View(df)
View(df3)
View(df2)
View(df3)
df$group = paste0(df$unit, "-", df$data.id)
View(df)
df0 = reshape2::dcast(df[c("group", "time", "value")],
time ~ group, value.var = "value")
View(df0)
res.icc = irr::icc(
df0[,-1], model = "oneway",
type = "c", unit = "single"
)$value
(nrow(sf.df3) - 1)*res.icc + 1
df0 = reshape2::dcast(df[c("unit", "time", "value")],
time ~ unit, value.var = "value")
View(df0)
df0 = reshape2::dcast(df[c("unit", "value")], value.var = "value")
units = unique(df$unit)
units
units = unique(df$unit)
df0 = NULL
for (item in units) {
temp = df %>% filter(unit == item) %>% select(gap_original)
df0 = cbind(df0, temp)
}
df0 = rep(0,304)
for (item in units) {
temp = df %>% filter(unit == item) %>% select(gap_original)
df0 = cbind(df0, temp)
}
View(df0)
res.icc = irr::icc(
df0[,-1], model = "oneway",
type = "c", unit = "single"
)$value
(nrow(sf.df3) - 1)*res.icc + 1
res.icc
res.icc = irr::icc(
df0[,-1], model = "twoway",
type = "a", unit = "single"
)$value
res.icc = irr::icc(
df0[,-1], model = "twoway",
type = "a", unit = "single"
)$value
(nrow(df0) - 1)*res.icc + 1
nrow(df0)
