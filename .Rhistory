df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
geom_vline(xintercept = treat_t)
treat_t = 119
id = 4
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
geom_vline(xintercept = treat_t)
rbind(data.frame(time = data_monthly$month[1:155],
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = data_monthly$month[1:155],
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
geom_vline(xintercept = treat_t)
data_monthly$month[1:155]
rbind(data.frame(time = data_monthly$month[1:155],
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = data_monthly$month[1:155],
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc"))
class(data_monthly$month)
rbind(data.frame(time = as.Date(data_monthly$month[1:155]),
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = as.Date(data_monthly$month[1:155]),
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
geom_vline(xintercept = treat_t)
as.Date(data_monthly$month[1:155], "%Y-%M")
data_monthly$month[1:155]
rbind(data.frame(time = as.Date(data_monthly$month[1:155], "%Y-%M"),
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = as.Date(data_monthly$month[1:155], "%Y-%M"),
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
geom_vline(xintercept = treat_t)
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
geom_vline(xintercept = treat_t)
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("True - Synthetic Control") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
library(checkpoint)
checkpoint("2022-04-01")
library(parallel)
n.cores = detectCores()
library(tidyverse)
library(furrr)
plan(multisession, workers = n.cores - 1)
options(future.rng.onMisuse="ignore")
options(stringsAsFactors = FALSE)
source("./R/utility/misc.R")
source("./R/utility/TFDTW.R")
source("./R/utility/synth.R")
source("./R/utility/implement.R")
source("./R/utility/grid.search.R")
set.seed(20220407)
data = readRDS("./data/bond.Rds")
data = reshape2::melt(data, id.vars = 1)
data_monthly = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, month) %>%
summarise(value = mean(value, na.rm = T)) %>%
mutate(time = 1:155,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "month")) %>%
data.frame(.)
#     do.call("rbind", .)
#   mse$file = file
#   results[[file]] = mse
# }
#
# results = results %>%
#   do.call("rbind", .) %>%
#   `rownames<-`(NULL)
#
# saveRDS(results, "./data/bond_results.Rds")
results = readRDS("./data/bond_results.Rds")
target = "TIP"
mse = results %>%
filter(unit == target) %>%
group_by(file) %>%
filter(error20 == min(error20)) %>%
filter(id == min(id))
data_monthly %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line() +
geom_vline(xintercept = 116)
data_monthly %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line() +
geom_vline(xintercept = 119)
data_monthly %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line() +
geom_vline(xintercept = 119) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 119
id = 4
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
target = "TIP"
mse = results %>%
filter(unit == target) %>%
group_by(file) %>%
filter(error20 == min(error20)) %>%
filter(id == min(id))
View(mse)
treat_t = 118
id = 4
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 120
id = 75
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 117
id = 75
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
data_monthly %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line() +
geom_vline(xintercept = 119) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 119
id = 20
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
id = 4
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
id = 5
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
id = 3
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 120
id = 75
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 119
id = 4
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
id = 5
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
id = 3
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
data_monthly %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line() +
geom_vline(xintercept = 119) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
data_monthly %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line() +
geom_vline(xintercept = 123) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 100
id = 30
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 110
id = 214
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond/bond_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 123
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 122
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 122
155*30
