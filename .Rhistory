error20 = mean((error[(treat_time-20):(treat_time-1)])^2, na.rm = TRUE)
item$mse$error20[i] = error20
}
item$mse
}
) %>%
do.call("rbind", .)
mse$file = file
results[[file]] = mse
}
results = results %>%
do.call("rbind", .) %>%
`rownames<-`(NULL)
target = "TIP"
mse = results %>%
filter(unit == target) %>%
group_by(file) %>%
filter(error20 == min(error20)) %>%
filter(id == min(id))
treat_t = 118
id = 145
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond2/bond_last_", treat_t, ".Rds"))[[id]]
treat_t = 118
id = 145
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond3/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 119
id = 145
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond3/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 120
id = 75
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond3/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 112
id = 4
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond3/bond_first_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
treat_t = 116
id = 75
#TIP 110 75, 119 4, 111 5,
df = readRDS(paste0("./data/bond3/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
data = readRDS("./data/bond.Rds")
data = reshape2::melt(data, id.vars = 1)
data_daily = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, date) %>%
# summarise(value = mean(value, na.rm = T)) %>%
# summarise(value = first(value)) %>%
summarise(value = last(value)) %>%
mutate(time = 1:3339,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "date")) %>%
data.frame(.) %>%
filter(date > as.Date("2016-01-01"))
7232/4
data_daily = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, date) %>%
# summarise(value = mean(value, na.rm = T)) %>%
# summarise(value = first(value)) %>%
summarise(value = last(value)) %>%
mutate(time = 1:3339,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "date")) %>%
data.frame(.) %>%
filter(date > as.Date("2018-01-01"))
5168/4
data = readRDS("./data/bond.Rds")
data = reshape2::melt(data, id.vars = 1)
data_daily = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, date) %>%
# summarise(value = mean(value, na.rm = T)) %>%
# summarise(value = first(value)) %>%
summarise(value = last(value)) %>%
mutate(time = 1:3339,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "date")) %>%
data.frame(.) %>%
filter(date > as.Date("2018-01-01"))
View(data_daily)
data_monthly = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, month) %>%
# summarise(value = mean(value, na.rm = T)) %>%
# summarise(value = first(value)) %>%
summarise(value = last(value)) %>%
mutate(time = 1:155,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "month")) %>%
data.frame(.)
View(data_monthly)
## Grid Search -----------------------------------------------------------------
target = "IBCI.DE"
treat_time = 2563
## Grid Search -----------------------------------------------------------------
target = "TIP"
treat_time = 2563
# parameters
filter.width.range = 12*30+1
k.range = 12*30
# parameters
filter.width.range = 3*30+1
k.range = 3*30
step.pattern.range = list(
# symmetricP0 = dtw::symmetricP0, # too bumpy
# symmetricP05 = dtw::symmetricP05,
# symmetricP1 = dtw::symmetricP1,
symmetricP2 = dtw::symmetricP2,
# asymmetricP0 = dtw::asymmetricP0, # too bumpy
# asymmetricP05 = dtw::asymmetricP05,
# asymmetricP1 = dtw::asymmetricP1,
# asymmetricP2 = dtw::asymmetricP2,
# typeIc = dtw::typeIc,
# typeIcs = dtw::typeIcs,
# typeIIc = dtw::typeIIc,  # jumps
# typeIIIc = dtw::typeIIIc, # jumps
# typeIVc = dtw::typeIVc,  # jumps
# typeId = dtw::typeId,
# typeIds = dtw::typeIds,
# typeIId = dtw::typeIId, # jumps
mori2006 = dtw::mori2006
)
grid.search.parallel = TRUE
args.TFDTW = list(buffer = 0, match.method = "fixed",
dist.quant = 0.95,
window.type = "none",
## other
norm.method = "t",
step.pattern2 = dtw::asymmetricP2,
n.burn = 3, n.IQR = 3,
ma = 3, ma.na = "original",
default.margin = 3,
n.q = 1, n.r = 1)
args.synth = list(predictors = NULL,
special.predictors =
list(
list("value_raw",(treat_time - 12*30):(treat_time - 1),c("mean"))
),
time.predictors.prior = 1:(treat_time - 1),
time.optimize.ssr = 1:(treat_time - 1))
5168/4
args.TFDTW.synth = list(start.time = 1, end.time = 1292, treat.time = treat_time,
args.TFDTW = args.TFDTW, args.synth = args.synth,
## 2nd
n.mse = 24*20,
## other
plot.figures = FALSE,
plot.path = "./figures/",
legend.pos = c(0.3, 0.3))
args.TFDTW.synth.all.units = list(target = target,
# data = data,
args.TFDTW.synth = args.TFDTW.synth,
## 2nd
detailed.output = TRUE,
all.units.parallel = FALSE)
args.TFDTW.synth.all.units[["data"]] = data_daily
results = SimDesign::quiet(
grid.search(filter.width.range = filter.width.range,
k.range = k.range,
step.pattern.range = step.pattern.range,
args.TFDTW.synth.all.units = args.TFDTW.synth.all.units,
grid.search.parallel = grid.search.parallel)
)
rep(1:3,4)
data_daily = data %>%
mutate(date = as.Date(date),
month = format(date, "%Y-%m"),
unit = as.character(variable),
id = as.numeric(variable)) %>%
group_by(id, unit, date) %>%
# summarise(value = mean(value, na.rm = T)) %>%
# summarise(value = first(value)) %>%
summarise(value = last(value)) %>%
mutate(time = 1:3339,
value_raw = value) %>%
ungroup() %>%
select(c("id", "unit", "time", "value", "value_raw", "date")) %>%
data.frame(.) %>%
filter(date > as.Date("2018-01-01")) %>%
mutate(time = rep(1:1292,4))
target = "TIP"
treat_time = 2563
# parameters
filter.width.range = 3*30+1
k.range = 3*30
step.pattern.range = list(
# symmetricP0 = dtw::symmetricP0, # too bumpy
# symmetricP05 = dtw::symmetricP05,
# symmetricP1 = dtw::symmetricP1,
symmetricP2 = dtw::symmetricP2,
# asymmetricP0 = dtw::asymmetricP0, # too bumpy
# asymmetricP05 = dtw::asymmetricP05,
# asymmetricP1 = dtw::asymmetricP1,
# asymmetricP2 = dtw::asymmetricP2,
# typeIc = dtw::typeIc,
# typeIcs = dtw::typeIcs,
# typeIIc = dtw::typeIIc,  # jumps
# typeIIIc = dtw::typeIIIc, # jumps
# typeIVc = dtw::typeIVc,  # jumps
# typeId = dtw::typeId,
# typeIds = dtw::typeIds,
# typeIId = dtw::typeIId, # jumps
mori2006 = dtw::mori2006
)
grid.search.parallel = TRUE
args.TFDTW = list(buffer = 0, match.method = "fixed",
dist.quant = 0.95,
window.type = "none",
## other
norm.method = "t",
step.pattern2 = dtw::asymmetricP2,
n.burn = 3, n.IQR = 3,
ma = 3, ma.na = "original",
default.margin = 3,
n.q = 1, n.r = 1)
args.synth = list(predictors = NULL,
special.predictors =
list(
list("value_raw",(treat_time - 12*30):(treat_time - 1),c("mean"))
),
time.predictors.prior = 1:(treat_time - 1),
time.optimize.ssr = 1:(treat_time - 1))
args.TFDTW.synth = list(start.time = 1, end.time = 1292, treat.time = treat_time,
args.TFDTW = args.TFDTW, args.synth = args.synth,
## 2nd
n.mse = 24*20,
## other
plot.figures = FALSE,
plot.path = "./figures/",
legend.pos = c(0.3, 0.3))
args.TFDTW.synth.all.units = list(target = target,
# data = data,
args.TFDTW.synth = args.TFDTW.synth,
## 2nd
detailed.output = TRUE,
all.units.parallel = FALSE)
args.TFDTW.synth.all.units[["data"]] = data_daily
results = SimDesign::quiet(
grid.search(filter.width.range = filter.width.range,
k.range = k.range,
step.pattern.range = step.pattern.range,
args.TFDTW.synth.all.units = args.TFDTW.synth.all.units,
grid.search.parallel = grid.search.parallel)
)
## Grid Search -----------------------------------------------------------------
target = "TIP"
treat_time = 516
# parameters
filter.width.range = 3*30+1
k.range = 3*30
step.pattern.range = list(
# symmetricP0 = dtw::symmetricP0, # too bumpy
# symmetricP05 = dtw::symmetricP05,
# symmetricP1 = dtw::symmetricP1,
symmetricP2 = dtw::symmetricP2,
# asymmetricP0 = dtw::asymmetricP0, # too bumpy
# asymmetricP05 = dtw::asymmetricP05,
# asymmetricP1 = dtw::asymmetricP1,
# asymmetricP2 = dtw::asymmetricP2,
# typeIc = dtw::typeIc,
# typeIcs = dtw::typeIcs,
# typeIIc = dtw::typeIIc,  # jumps
# typeIIIc = dtw::typeIIIc, # jumps
# typeIVc = dtw::typeIVc,  # jumps
# typeId = dtw::typeId,
# typeIds = dtw::typeIds,
# typeIId = dtw::typeIId, # jumps
mori2006 = dtw::mori2006
)
grid.search.parallel = TRUE
args.TFDTW = list(buffer = 0, match.method = "fixed",
dist.quant = 0.95,
window.type = "none",
## other
norm.method = "t",
step.pattern2 = dtw::asymmetricP2,
n.burn = 3, n.IQR = 3,
ma = 3, ma.na = "original",
default.margin = 3,
n.q = 1, n.r = 1)
args.synth = list(predictors = NULL,
special.predictors =
list(
list("value_raw",(treat_time - 12*30):(treat_time - 1),c("mean"))
),
time.predictors.prior = 1:(treat_time - 1),
time.optimize.ssr = 1:(treat_time - 1))
args.TFDTW.synth = list(start.time = 1, end.time = 1292, treat.time = treat_time,
args.TFDTW = args.TFDTW, args.synth = args.synth,
## 2nd
n.mse = 24*20,
## other
plot.figures = FALSE,
plot.path = "./figures/",
legend.pos = c(0.3, 0.3))
args.TFDTW.synth.all.units = list(target = target,
# data = data,
args.TFDTW.synth = args.TFDTW.synth,
## 2nd
detailed.output = TRUE,
all.units.parallel = FALSE)
args.TFDTW.synth.all.units[["data"]] = data_daily
results = SimDesign::quiet(
grid.search(filter.width.range = filter.width.range,
k.range = k.range,
step.pattern.range = step.pattern.range,
args.TFDTW.synth.all.units = args.TFDTW.synth.all.units,
grid.search.parallel = grid.search.parallel)
)
View(results)
View(results[["2"]][["mse"]])
saveRDS(results, paste0("./data/bond_daily_", treat_time, ".Rds"))
5168/4
# plot
df = results[[1]]
View(df)
target = "TIP"
treat_time = 516
rbind(data.frame(time = 1:1292,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:1292,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t)
# plot
df = results[[2]]
target = "TIP"
treat_time = 516
rbind(data.frame(time = 1:1292,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:1292,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t)
results2 = results
folder = "./data/bond3/"
file.list = list.files(folder)
results = NULL
for (file in file.list) {
print(file)
df = readRDS(paste0(folder, file))
treat_time = as.numeric(strsplit(strsplit(file, "[.]")[[1]][1], "_")[[1]][3])
mse = future_map2(
as.list(1:length(df)),
df,
~{
id = .x
item = .y
item$mse$id = id
item$mse$diff = 0
item$mse$error20 = 0
for (i in 1:4) {
unit = item$mse$unit[i]
error = (item$results.TFDTW.synth[[unit]]$res.synth.raw$value -
item$results.TFDTW.synth[[unit]]$res.synth.TFDTW$synthetic)
difference = (item$results.TFDTW.synth[[unit]]$res.synth.raw$synthetic -
item$results.TFDTW.synth[[unit]]$res.synth.TFDTW$synthetic)
msd = mean((difference[treat_time:(treat_time + 23)])^2, na.rm = TRUE)
item$mse$diff[i] = msd
error20 = mean((error[(treat_time-20):(treat_time-1)])^2, na.rm = TRUE)
item$mse$error20[i] = error20
}
item$mse
}
) %>%
do.call("rbind", .)
mse$file = file
results[[file]] = mse
}
results = results %>%
do.call("rbind", .) %>%
`rownames<-`(NULL)
target = "TIP"
mse = results %>%
filter(unit == target) %>%
group_by(file) %>%
filter(error20 == min(error20)) %>%
filter(id == min(id))
treat_t = 119
id = 145
#TIP 110 75, 119 4, 111 5,
#TIP last 119 145
df = readRDS(paste0("./data/bond3/bond_last_", treat_t, ".Rds"))[[id]]
rbind(data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.raw$synthetic,
unit = "sc"),
data.frame(time = 1:155,
value = df$results.TFDTW.synth[[target]]$res.synth.raw$value -
df$results.TFDTW.synth[[target]]$res.synth.TFDTW$synthetic,
unit = "dsc")) %>%
ggplot(aes(x = time, y = value, color = unit)) +
geom_line()  +
ylab("Observed - Synthetic Control") +
labs(color = "") +
geom_vline(xintercept = treat_t) +
scale_x_continuous(breaks = c(0, 48, 96, 144),
labels = c("2010", "2014", "2018", "2022"))
## Setup -----------------------------------------------------------------------
library(checkpoint)
checkpoint("2022-04-01")
library(parallel)
n.cores = detectCores()
library(tidyverse)
