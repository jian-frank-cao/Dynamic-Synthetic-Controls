res.icc = target/(target + EMS)
res.vif = 1 + (l - 1)*res.icc
DF.dsc = nrow(df)/res.vif
res.aov.sc = aov(gap_original ~ id*target, df)
summary.aov.sc = summary(res.aov.sc)
BMS = summary.aov.sc[[1]]$`Mean Sq`[1]
JMS = summary.aov.sc[[1]]$`Mean Sq`[2]
IMS = summary.aov.sc[[1]]$`Mean Sq`[3]
EMS = summary.aov.sc[[1]]$`Mean Sq`[4]
target = (BMS-IMS)/(l*k) + (JMS-IMS)/(l*n) + (IMS-EMS)/(l)
res.icc = target/(target + EMS)
res.vif = 1 + (l - 1)*res.icc
DF.sc = nrow(df)/res.vif
var.sc = df %>% group_by(unit) %>%
summarise(variance = var(gap_original, na.rm = T)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
var.dsc = df %>% group_by(unit) %>%
summarise(variance = var(gap_new, NA.RM = T)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
var.sc = df %>% group_by(unit) %>%
summarise(variance = var(gap_original, na.rm = T)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
var.dsc = df %>% group_by(unit) %>%
summarise(variance = var(gap_new, na.rm = T)*(n.t - 1)) %>%
ungroup %>%
.[["variance"]] %>%
sum(., na.rm = T)/(n.datasets*(n.t - 1))
f.value = var.dsc/var.sc
p.value = pf(f.value, DF.dsc, DF.sc, lower.tail = TRUE)*2
var.dsc
var.sc
f.value
p.value
pf(0.9307, 3000, 3000)*2
combn(1:5, 2, simplify = T)
set.seed(20220407)
## California Tobacco Data -----------------------------------------------------
load("./data/smoking.rda")
prop99 = read.csv("./data/prop99.csv")
exclude_states = c("Massachusetts", "Arizona", "Oregon", "Florida",
"Alaska", "Hawaii", "Maryland", "Michigan",
"New Jersey", "New York",
"Washington", "District of Columbia")
include_states = sort(setdiff(unique(prop99$LocationDesc),
exclude_states))
states = data.frame(id = 1:length(include_states),
unit = include_states)
smoking = smoking %>% mutate_all(as.numeric)
colnames(smoking)[1:3] = c("id", "time", "value")
smoking = right_join(states, smoking, by = "id")
smoking = smoking %>%
mutate(value_raw = value,
age15to24 = age15to24*100)
data = smoking
# rescale
df.rescale = data %>%
filter(time <= 1989) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "California",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
ids
selection = combn(diff(ids, 3), 2)
selection
selection = combn(diff(ids, 3), 2, simplify = TRUE)
selection
selection = combn(diff(ids, 3), 2, simplify = TRUE)[,1:100]
selection
setdiff(ids, 3)
selection = combn(setdiff(ids, 3), 2, simplify = TRUE)[,1:100]
selection
c(selection[,2], 3)
set.seed(20220407)
## California Tobacco Data -----------------------------------------------------
load("./data/smoking.rda")
prop99 = read.csv("./data/prop99.csv")
exclude_states = c("Massachusetts", "Arizona", "Oregon", "Florida",
"Alaska", "Hawaii", "Maryland", "Michigan",
"New Jersey", "New York",
"Washington", "District of Columbia")
include_states = sort(setdiff(unique(prop99$LocationDesc),
exclude_states))
states = data.frame(id = 1:length(include_states),
unit = include_states)
smoking = smoking %>% mutate_all(as.numeric)
colnames(smoking)[1:3] = c("id", "time", "value")
smoking = right_join(states, smoking, by = "id")
smoking = smoking %>%
mutate(value_raw = value,
age15to24 = age15to24*100)
data = smoking
# rescale
df.rescale = data %>%
filter(time <= 1989) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "California",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
selection = combn(setdiff(ids, 3), 2, simplify = TRUE)[,1:100]
for (i in ncol(selection)) {
data.temp = data %>% filter(!(id %in% c(selection[, i], 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
View(data.list)
1:ncol(selection)
set.seed(20220407)
## California Tobacco Data -----------------------------------------------------
load("./data/smoking.rda")
prop99 = read.csv("./data/prop99.csv")
exclude_states = c("Massachusetts", "Arizona", "Oregon", "Florida",
"Alaska", "Hawaii", "Maryland", "Michigan",
"New Jersey", "New York",
"Washington", "District of Columbia")
include_states = sort(setdiff(unique(prop99$LocationDesc),
exclude_states))
states = data.frame(id = 1:length(include_states),
unit = include_states)
smoking = smoking %>% mutate_all(as.numeric)
colnames(smoking)[1:3] = c("id", "time", "value")
smoking = right_join(states, smoking, by = "id")
smoking = smoking %>%
mutate(value_raw = value,
age15to24 = age15to24*100)
data = smoking
# rescale
df.rescale = data %>%
filter(time <= 1989) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "California",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
selection = combn(setdiff(ids, 3), 2, simplify = TRUE)[,1:100]
for (i in 1:ncol(selection)) {
data.temp = data %>% filter(!(id %in% c(selection[, i], 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
set.seed(20220407)
## California Tobacco Data -----------------------------------------------------
load("./data/smoking.rda")
prop99 = read.csv("./data/prop99.csv")
exclude_states = c("Massachusetts", "Arizona", "Oregon", "Florida",
"Alaska", "Hawaii", "Maryland", "Michigan",
"New Jersey", "New York",
"Washington", "District of Columbia")
include_states = sort(setdiff(unique(prop99$LocationDesc),
exclude_states))
states = data.frame(id = 1:length(include_states),
unit = include_states)
smoking = smoking %>% mutate_all(as.numeric)
colnames(smoking)[1:3] = c("id", "time", "value")
smoking = right_join(states, smoking, by = "id")
smoking = smoking %>%
mutate(value_raw = value,
age15to24 = age15to24*100)
data = smoking
# rescale
df.rescale = data %>%
filter(time <= 1989) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "California",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
set.seed(20220407)
## California Tobacco Data -----------------------------------------------------
load("./data/smoking.rda")
prop99 = read.csv("./data/prop99.csv")
exclude_states = c("Massachusetts", "Arizona", "Oregon", "Florida",
"Alaska", "Hawaii", "Maryland", "Michigan",
"New Jersey", "New York",
"Washington", "District of Columbia")
include_states = sort(setdiff(unique(prop99$LocationDesc),
exclude_states))
states = data.frame(id = 1:length(include_states),
unit = include_states)
smoking = smoking %>% mutate_all(as.numeric)
colnames(smoking)[1:3] = c("id", "time", "value")
smoking = right_join(states, smoking, by = "id")
smoking = smoking %>%
mutate(value_raw = value,
age15to24 = age15to24*100)
data = smoking
# rescale
df.rescale = data %>%
filter(time <= 1989) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "California",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
selection = combn(setdiff(ids, 3), 2, simplify = TRUE)[,1:100]
for (i in 1:ncol(selection)) {
data.temp = data %>% filter(!(id %in% c(selection[, i], 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
<<<<<<< HEAD
=======
library(checkpoint)
checkpoint("2022-04-01")
>>>>>>> 161aa88124983803c1b68fda5940745318593344
library(tidyverse)
library(furrr)
plan(multisession, workers = 8)
options(future.rng.onMisuse="ignore")
options(stringsAsFactors = FALSE)
source("./R/misc.R")
source("./R/TFDTW.R")
source("./R/synth.R")
source("./R/implement.R")
source("./R/grid.search.R")
set.seed(20220407)
<<<<<<< HEAD
load("./data/smoking.rda")
prop99 = read.csv("./data/prop99.csv")
exclude_states = c("Massachusetts", "Arizona", "Oregon", "Florida",
"Alaska", "Hawaii", "Maryland", "Michigan",
"New Jersey", "New York",
"Washington", "District of Columbia")
include_states = sort(setdiff(unique(prop99$LocationDesc),
exclude_states))
states = data.frame(id = 1:length(include_states),
unit = include_states)
smoking = smoking %>% mutate_all(as.numeric)
colnames(smoking)[1:3] = c("id", "time", "value")
smoking = right_join(states, smoking, by = "id")
smoking = smoking %>%
mutate(value_raw = value,
age15to24 = age15to24*100)
data = smoking
# rescale
df.rescale = data %>%
filter(time <= 1989) %>%
=======
## Germany Reunification Data --------------------------------------------------
data = readRDS("./data/repgermany.Rds")
colnames(data)[1:4] = c("id", "unit", "time", "value")
data = data %>% mutate(value_raw = value)
# rescale
df.rescale = data %>%
filter(time <= 1990) %>%
>>>>>>> 161aa88124983803c1b68fda5940745318593344
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
<<<<<<< HEAD
data.list = list(list(target = "California",
=======
data.list = list(list(target = "West Germany",
>>>>>>> 161aa88124983803c1b68fda5940745318593344
data = data))
ids = data$id %>%
unique
for (i in ids) {
<<<<<<< HEAD
data.temp = data %>% filter(!(id %in% c(i, 3)))
=======
data.temp = data %>% filter(!(id %in% c(i, 7)))
>>>>>>> 161aa88124983803c1b68fda5940745318593344
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
<<<<<<< HEAD
select2 = combn(setdiff(ids, 3), 2, simplify = TRUE)[,1:100]
for (i in 1:ncol(select2)) {
data.temp = data %>% filter(!(id %in% c(select2[, i], 3)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
View(data.list)
set.seed(20220407)
## California Tobacco Data -----------------------------------------------------
load("./data/smoking.rda")
prop99 = read.csv("./data/prop99.csv")
exclude_states = c("Massachusetts", "Arizona", "Oregon", "Florida",
"Alaska", "Hawaii", "Maryland", "Michigan",
"New Jersey", "New York",
"Washington", "District of Columbia")
include_states = sort(setdiff(unique(prop99$LocationDesc),
exclude_states))
states = data.frame(id = 1:length(include_states),
unit = include_states)
smoking = smoking %>% mutate_all(as.numeric)
colnames(smoking)[1:3] = c("id", "time", "value")
smoking = right_join(states, smoking, by = "id")
smoking = smoking %>%
mutate(value_raw = value,
age15to24 = age15to24*100)
data = smoking
# rescale
df.rescale = data %>%
filter(time <= 1989) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "California",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 3)))
=======
select2 = combn(setdiff(ids, 7), 2, simplify = TRUE)[,1:100]
for (i in 1:ncol(select2)) {
data.temp = data %>% filter(!(id %in% c(select2[, i], 7)))
>>>>>>> 161aa88124983803c1b68fda5940745318593344
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
library(tidyverse)
library(furrr)
plan(multisession, workers = 8)
options(future.rng.onMisuse="ignore")
options(stringsAsFactors = FALSE)
source("./R/misc.R")
source("./R/TFDTW.R")
source("./R/synth.R")
source("./R/implement.R")
source("./R/grid.search.R")
set.seed(20220407)
## Basque Terrorism Data -------------------------------------------------------
data(basque, package = "Synth")
data = basque
colnames(data)[1:4] = c("id", "unit", "time", "value")
data = data %>% mutate(invest_ratio = invest/value,
value_raw = value)
# rescale
df.rescale = data %>%
filter(time <= 1970) %>%
group_by(unit) %>%
summarise(value.min = min(value),
value.max = max(value)) %>%
ungroup()
mean.diff = mean(df.rescale$value.max - df.rescale$value.min)
df.rescale = df.rescale %>%
mutate(
multiplier = mean.diff/(value.max - value.min)
)
data = left_join(data, df.rescale, by = "unit")
data = data %>%
mutate(
value.bak = value_raw,
value_raw = (value_raw - value.min)*multiplier,
value = value_raw
)
# data list
data.list = list(list(target = "Basque Country (Pais Vasco)",
data = data))
ids = data$id %>%
unique
for (i in ids) {
data.temp = data %>% filter(!(id %in% c(i, 17)))
data.list = c(data.list,
list(list(target = data.temp$unit[1],
data = data.temp)))
}
select2 = combn(setdiff(ids, 17), 2, simplify = TRUE)[,1:100]
